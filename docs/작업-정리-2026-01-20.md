# 작업 정리 (2026-01-20)

## 1) 문제가 되었던 현상
- **대화 로그가 2번씩 찍힘**
  - 스트리밍 중간 결과와 최종 결과가 각각 다른 이벤트로 들어와 동일한 문장이 두 줄로 출력됨.
- **내 발화도 중복으로 출력됨**
  - 음성 입력은 부분 전사(delta)와 최종 전사(completed)가 분리되어, 둘 다 로그에 찍히는 구조였음.
- **대화가 덮어씌워져 기록이 쌓이지 않음**
  - 스트리밍 줄을 계속 갱신하는 로직이 새로운 턴에도 적용되어 과거 기록이 덮어써짐.
- **Realtime 연결 오류 (SDP 파싱 오류)**
  - `setRemoteDescription` 에러 발생: SDP 대신 JSON 에러 응답이 들어오는 케이스.
  - 주 원인은 **만료/잘못된 에페메럴 토큰** 또는 **서버 에러 응답**.

## 2) 원인 분석과 해결

### A. 대화 중복(assistant/user)
**원인**
- 스트리밍 결과(부분 전사)와 최종 결과가 **서로 다른 이벤트로 전달**됨.
- UI에서 같은 턴을 구분할 키가 없어, 최종 결과가 새로운 줄로 추가됨.

**해결**
- Realtime 이벤트에서 `responseId`/`itemId`를 전달하고, UI에서 **키 기반으로 같은 줄을 갱신**하도록 변경.
- 사용자 발화는 최종 전사(`conversation.item.input_audio_transcription.completed`)만 로그에 추가하도록 변경.

**왜 이렇게 해결했는가**
- 스트리밍은 UX 개선 요소일 뿐이며, **최종 텍스트를 단 한 줄로 확정**하는 것이 중복 제거에 가장 확실함.
- `responseId`/`itemId`를 기준으로 묶으면, 델타/최종 이벤트를 **같은 로그 엔트리로 안정적으로 병합**할 수 있음.

---

### B. 기록이 덮어써지는 문제
**원인**
- 스트리밍 중간 결과를 갱신하는 로직이 **새 턴에도 계속 적용**되어 기존 줄을 덮어씀.

**해결**
- 최종 방침을 **“완성된 문장만 누적”**으로 변경.
- 스트리밍/타자 효과 로직을 제거하고, `isFinal`일 때만 로그에 추가하도록 단순화.

**왜 이렇게 해결했는가**
- 요구사항이 “완성된 채팅만 누적”으로 확정되었고,
  이 방식이 **중복 및 덮어쓰기 이슈를 가장 단순하게 제거**함.

---

### C. Realtime 연결 오류 (SDP 파싱 실패)
**원인**
- 브라우저가 SDP를 기대하는데, 실제 응답은 **에러 JSON**.
- 원인은 **만료된 토큰/잘못된 토큰** 또는 **서버 에러 응답**.

**해결**
- 연결 직전에 에페메럴 토큰을 **항상 새로 발급**.
- 토큰 응답을 **형태 정규화**하고 유효성 검증을 강화.
- 연결 시도 중복 방지 및 재시도 로직 추가.

**왜 이렇게 해결했는가**
- 토큰이 만료되면 서버는 정상 SDP가 아닌 JSON 에러를 반환함.
- “연결 직전 토큰 발급 + 응답 검증”이 가장 안정적인 방법.

---

## 3) 최종 동작 요약
- **대화 로그는 완성된 문장만 누적**됨.
- 스트리밍/타자 효과 제거.
- 중복 출력 및 덮어쓰기 방지.
- Realtime 연결 안정화(토큰 만료 대응).

---

## 4) 변경 파일
- web/components/VoiceSurveyClient.tsx
  - 스트리밍/타이핑 제거 → 완성된 채팅만 누적
  - 토큰 발급/연결 안정화
- web/lib/realtimeClient.ts
  - Realtime 이벤트 처리 안정화
  - 중복 전사 방지 로직 정리
- web/app/api/realtime-token/route.ts
  - 토큰 응답 정규화
- web/lib/systemPrompt.ts
  - 시스템 프롬프트 갱신 반영
- web/package-lock.json
  - 의존성 변동 반영
