# 작업 정리 (2026-01-20)

## 1) 문제가 되었던 현상
- **대화 로그가 2번씩 찍힘**
  - 스트리밍 중간 결과와 최종 결과가 각각 다른 이벤트로 들어와 동일한 문장이 두 줄로 출력됨.
- **내 발화도 중복으로 출력됨**
  - 음성 입력은 부분 전사(delta)와 최종 전사(completed)가 분리되어, 둘 다 로그에 찍히는 구조였음.
- **대화가 덮어씌워져 기록이 쌓이지 않음**
  - 스트리밍 줄을 계속 갱신하는 로직이 새로운 턴에도 적용되어 과거 기록이 덮어써짐.
- **AI가 먼저 말하지 않음**
  - 연결 직후에 선발화가 트리거되지 않아 사용자가 먼저 말해야 대화가 시작되는 문제.
- **세션 시작 전에도 마이크/대화가 활성화됨**
  - 버튼을 누르기 전에도 연결/마이크가 동작하여 예상과 다른 UX가 발생.
- **`requestResponse is not defined` 런타임 에러**
  - 응답 트리거 함수가 스코프 밖에서 참조되어 ReferenceError 발생.
- **시스템 프롬프트 원문이 그대로 주입되지 않음**
  - 빌드 시점에 가공된 문자열을 쓰는 구조로 인해 “원문 그대로” 요구와 충돌.
- **한국어 전사 안정성 문제**
  - 환경/SDK에 따라 전사 언어가 기대와 다르게 인식되는 현상.
- **Realtime 연결 오류 (SDP 파싱 오류)**
  - `setRemoteDescription` 에러 발생: SDP 대신 JSON 에러 응답이 들어오는 케이스.
  - 주 원인은 **만료/잘못된 에페메럴 토큰** 또는 **서버 에러 응답**.

## 2) 원인 분석과 해결

### A. 대화 중복(assistant/user)
**원인**
- 스트리밍 결과(부분 전사)와 최종 결과가 **서로 다른 이벤트로 전달**됨.
- UI에서 같은 턴을 구분할 키가 없어, 최종 결과가 새로운 줄로 추가됨.

**해결**
- Realtime 이벤트에서 `responseId`/`itemId`를 전달하고, UI에서 **키 기반으로 같은 줄을 갱신**하도록 변경.
- 사용자 발화는 최종 전사(`conversation.item.input_audio_transcription.completed`)만 로그에 추가하도록 변경.

**왜 이렇게 해결했는가**
- 스트리밍은 UX 개선 요소일 뿐이며, **최종 텍스트를 단 한 줄로 확정**하는 것이 중복 제거에 가장 확실함.
- `responseId`/`itemId`를 기준으로 묶으면, 델타/최종 이벤트를 **같은 로그 엔트리로 안정적으로 병합**할 수 있음.

---

### B. 기록이 덮어써지는 문제
**원인**
- 스트리밍 중간 결과를 갱신하는 로직이 **새 턴에도 계속 적용**되어 기존 줄을 덮어씀.

**해결**
- 최종 방침을 **“완성된 문장만 누적”**으로 변경.
- 스트리밍/타자 효과 로직을 제거하고, `isFinal`일 때만 로그에 추가하도록 단순화.

**왜 이렇게 해결했는가**
- 요구사항이 “완성된 채팅만 누적”으로 확정되었고,
  이 방식이 **중복 및 덮어쓰기 이슈를 가장 단순하게 제거**함.

---

### C. Realtime 연결 오류 (SDP 파싱 실패)
**원인**
- 브라우저가 SDP를 기대하는데, 실제 응답은 **에러 JSON**.
- 원인은 **만료된 토큰/잘못된 토큰** 또는 **서버 에러 응답**.

**해결**
- 연결 직전에 에페메럴 토큰을 **항상 새로 발급**.
- 토큰 응답을 **형태 정규화**하고 유효성 검증을 강화.
- 연결 시도 중복 방지 및 재시도 로직 추가.

**왜 이렇게 해결했는가**
- 토큰이 만료되면 서버는 정상 SDP가 아닌 JSON 에러를 반환함.
- “연결 직전 토큰 발급 + 응답 검증”이 가장 안정적인 방법.

---

### D. AI 선발화(자동 시작) 미동작
**원인**
- Realtime 연결 직후에 응답 생성을 트리거하는 이벤트가 부족하거나 순서가 맞지 않아,
  사용자가 먼저 발화해야만 응답이 생성됨.

**해결**
- 연결 직후 `session.update`로 오디오 출력 설정을 확정.
- 선발화 텍스트를 `session.sendMessage()`로 입력한 뒤 `response.create`를 호출해
  **자동 첫 응답**이 생성되도록 구성.

**왜 이렇게 해결했는가**
- Realtime에서 “응답 생성”은 명시적인 `response.create` 트리거가 필요하고,
  선발화 텍스트는 대화 히스토리로 주입되어야 안정적으로 첫 발화가 발생함.

---

### E. 세션 시작 전 활성화 문제
**원인**
- 초기 렌더 시점에 연결/마이크가 준비되면서, 사용자가 버튼을 누르기 전에 동작이 시작됨.

**해결**
- 연결은 버튼 클릭 시점에만 수행하도록 지연.
- 연결 직후에는 `mute(true)`로 시작하고, 사용자가 시작 버튼을 눌러야 `startMic()`가 동작하도록 변경.

**왜 이렇게 해결했는가**
- 사용자의 명시적 액션 이후에만 음성 권한/전송이 시작되는 것이 UX와 프라이버시 기대에 부합.

---

### F. `requestResponse is not defined` 런타임 에러
**원인**
- 응답 트리거 함수가 `connect()` 내부 스코프에만 존재했는데 외부에서 참조하여 에러 발생.

**해결**
- `requestResponse()`를 상위 스코프로 이동하고, transport 참조를 공유하도록 구성.

**왜 이렇게 해결했는가**
- 동일한 함수가 UI/이벤트 핸들러에서 재사용되므로 스코프를 분리해 안정적으로 참조 가능하도록 함.

---

### G. 시스템 프롬프트 원문 주입
**원인**
- 빌드 스크립트가 Markdown을 문자열로 변환하면서 “원문 그대로 주입” 요구와 불일치.

**해결**
- 서버 라우트에서 Markdown을 런타임에 직접 읽어 `instructions`로 전달.

**왜 이렇게 해결했는가**
- 런타임 읽기는 가공 없이 원문을 그대로 전달할 수 있는 가장 단순하고 확실한 방식.

---

### H. 한국어 전사 설정 이슈
**원인**
- 토큰 발급 요청에 미지원 파라미터를 넣으면 400이 발생하여 연결 자체가 깨짐.

**해결**
- 토큰 발급 요청에서는 해당 파라미터를 제거하고,
  클라이언트 `session.update`에서 전사 힌트를 설정.

**왜 이렇게 해결했는가**
- 서버에서 거부되는 필드는 제거하고, 클라이언트 수준에서 가능한 설정만 적용해 안정성 확보.

## 3) 최종 동작 요약
- **대화 로그는 완성된 문장만 누적**됨.
- 스트리밍/타자 효과 제거.
- 중복 출력 및 덮어쓰기 방지.
- Realtime 연결 안정화(토큰 만료 대응).
- 연결 직후 **AI가 선발화**하도록 자동 시작 구성.
- 세션 시작 전에는 마이크가 동작하지 않도록 제어.

---

## 4) 변경 파일
- web/components/VoiceSurveyClient.tsx
  - 스트리밍/타이핑 제거 → 완성된 채팅만 누적
  - 토큰 발급/연결 안정화
  - 세션 시작 버튼 기반 연결/마이크 제어
- web/lib/realtimeClient.ts
  - Realtime 이벤트 처리 안정화
  - 중복 전사 방지 로직 정리
  - `requestResponse` 스코프 오류 수정
  - 선발화 트리거 구성
- web/app/api/realtime-token/route.ts
  - 토큰 응답 정규화
  - 시스템 프롬프트 원문 주입
- web/lib/systemPrompt.ts
  - 시스템 프롬프트 갱신 반영
- web/package-lock.json
  - 의존성 변동 반영
