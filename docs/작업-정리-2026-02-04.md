# 작업 정리 (2026-02-04)

## 배경
- 음성 설문 진행 후 세션 종료 시, 대화 로그를 기반으로 설문 답변(JSON)을 정리해 MongoDB에 저장하는 흐름에서
  - 질문-답변 매칭이 어긋나거나
  - 근거 없는 결론(예: "영화관에 가는 것이 불편하다")이 확정 답변으로 저장되는 문제가 발생.

## 목표
- 대화 단계(Realtime)와 정리 단계(ChatGPT 추출)가 **동일한 설문 정의(SurveyDefinition)**를 기준으로 동작하게 정렬.
- 명시적 답변(확정)과 비언어적/맥락 신호(가설)를 **서로 다른 필드로 분리**하여 저장.

## 변경 사항

### 1) 대화 프롬프트를 설문 정의와 동기화
- [app/api/system-prompt/route.ts](app/api/system-prompt/route.ts)
  - 최신 SurveyDefinition을 조회하여, 대화용 system prompt에 "Active Survey Definition"(질문 목록/옵션/운영 규칙)을 덧붙여 반환.
  - 클라이언트가 제출 시 사용할 `definitionId`도 함께 반환.

- [lib/server/interviewPrompt.ts](lib/server/interviewPrompt.ts)
  - SurveyDefinition을 기반으로 "질문 목록 + 진행 규칙"을 생성.
  - 질문과 다른 주제로 말하는 것을 허용하되, 공감/확인 후 원래 질문으로 복귀하도록 설계.
  - 비언어적/행동 신호로부터 가설을 세우는 것은 허용하고, 반드시 확인 질문으로 검증하도록 규칙을 포함.

- [app/(survey)/_components/VoiceSurveyClient.tsx](app/(survey)/_components/VoiceSurveyClient.tsx)
  - `/api/system-prompt`에서 내려주는 `definitionId`를 보관.
  - `/api/survey-submissions` 제출 시 `definitionId`를 함께 전송하여, 저장/추출 모두 동일한 설문 정의를 사용하도록 고정.

### 2) 정리(추출) 결과의 "확정" vs "가설" 분리 저장
- [lib/server/models/SurveyResponse.ts](lib/server/models/SurveyResponse.ts)
  - 답변 스키마에 다음 필드를 추가해, 결론 단정을 `value`에 직접 저장하지 않고도 추론을 담을 수 있게 함.
    - `confidence?: number`
    - `evidence?: string[]`
    - `hypotheses?: { value, confidence, evidence }[]`

- [lib/server/promptBuilder.ts](lib/server/promptBuilder.ts)
  - 추출 프롬프트를 강화:
    - 근거 없는 내용은 `value=null` 유지
    - 비언어적/행동 신호 기반 추론은 `hypotheses`에만 기록(근거/확신도 포함)
    - `SCALE`, `CURRENCY` 타입 템플릿 추가

- [lib/server/surveyService.ts](lib/server/surveyService.ts)
  - OpenAI 호출에 `response_format: json_object` 사용.
  - 추출 결과를 설문 정의의 질문 ID 기준으로 정규화하여 누락/파싱 실패 시에도 `value=null`로 안정화.
  - `confidence/evidence/hypotheses`가 있으면 함께 저장.

### 3) 대화 시스템 프롬프트 개선
- [prompts/elderly-mobility-system.md](prompts/elderly-mobility-system.md)
  - 고객사 설문지 운영 관점에 맞게 전반 리라이트.
  - 비언어적 요소는 "관찰 → 가설 → 확인" 흐름으로 다루도록 명시.

## 기대 효과
- 대화 단계와 정리 단계가 같은 설문 정의를 기준으로 돌아, 질문-답변 매칭 오류가 크게 감소.
- 사용자가 말하지 않은 결론이 "확정 답변(value)"로 저장되는 문제를 줄이고,
  필요한 경우에는 `hypotheses`로 "추론"을 보관할 수 있음.

## 확인 방법
1) `npm run dev` 실행
2) 설문 정의 생성 후 설문 진행
3) 설문 종료(마이크 종료) 시 제출 payload에 `definitionId`가 포함되는지 확인
4) `/admin`에서 저장된 answers에
   - 확정값은 `value`
   - 추론은 `hypotheses`
   로 분리되어 저장되는지 확인

## 메모
- `.env`는 `.gitignore`에 포함되어 추적되지 않도록 설정됨.
